// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

import {IntegrationTest} from "silo-foundry-utils/networks/IntegrationTest.sol";
import {AddrKey} from "common/addresses/AddrKey.sol";

import {IERC20} from "openzeppelin5/token/ERC20/IERC20.sol";

import {DexSwap} from "silo-core/contracts/utils/liquidationHelper/DexSwap.sol";

/*
 FOUNDRY_PROFILE=core_test forge test --gas-price 1 -vv --mc DexSwapEnsoSonicTest
*/
contract DexSwapEnsoSonicTest is IntegrationTest {
    DexSwap dex; // solhint-disable-line var-name-mixedcase

    function _setUp() public {

        uint256 blockToFork = 36036102;
        vm.createSelectFork(vm.envString("RPC_SONIC"), blockToFork);
        dex = new DexSwap(getAddress(AddrKey.ENSO_ROUTER));
    }

    function test_skip_fillQuote_PT() public {
        _setUp();
        emit log_named_address("DexSwap", address(dex));

        address whale = 0xbdA08253cdC574FD1B48BaD82256b09D6ea1aa2E;

        IERC20 sellToken = IERC20(0xBe27993204Ec64238F71A527B4c4D5F4949034C3); // PT
        vm.prank(whale);
        sellToken.transfer(address(dex),186688269);

        IERC20 buyToken = IERC20(0x29219dd400f2Bf60E5a23d13Be72B486D4038894); // USDC
        address allowanceTarget = getAddress(AddrKey.ENSO_ROUTER);

        uint256 usdcBefore = buyToken.balanceOf(address(dex));
        assertEq(usdcBefore, 0, "expect to have no USDC");

        bytes memory swapCallData = abi.encodePacked(
            hex"b94c3609000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000be27993204ec64238f71a527b4c4d5f4949034c3000000000000000000000000000000000000000000000000000000000b205a2000000000000000000000000000000000000000000000000000000000000016c495352c9f1bbdc3a4a5bc8aea52dc30cbd257fa628bc4bb4dcfc5a3dde2120344a50bc44f38cc337ebdaf5cb0d24a2a9b3202a2475ab643de71865b491edda0e328619a3100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000000d095ea7b3010001ffffffffffbe27993204ec64238f71a527b4c4d5f4949034c370a082310102ffffffffff00896f4d49916ac5cfc36d7a260a7039ba4ea317b6339748cb0102030104ffffff888888888889758f76e7103c6cbf23abbf58f94670a082310102ffffffffff04896f4d49916ac5cfc36d7a260a7039ba4ea317b6b67d77c5010400ffffffff04ca99eaa38e8f37a168214a3a57c9a45a58563ed5095ea7b3010504ffffffffff896f4d49916ac5cfc36d7a260a7039ba4ea317b6769f8e5d010204060707ff04896f4d49916ac5cfc36d7a260a7039ba4ea317b6ba08765201040202ffffff049fb76f7ce5fceaa2c42887ff441d46095e494206095ea7b3010804ffffffffff4d85ba8c3918359c78ed09581e5bc7578ba932ba346387bf4100000000000004bedfac7488dccaafdd66d1d7d56349780fe0477e09090a0b040c0d0e8f90ffffffffffffffffffffffffffffffffffffffffffff6e7a43a3010411ffffffff047e7d64d987cab6eed08a191c4c2459daf2f8ed0b241c59120104ffffffffffff7e7d64d987cab6eed08a191c4c2459daf2f8ed0b00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000240000000000000000000000000000000000000000000000000000000000000028000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000440000000000000000000000000000000000000000000000000000000000000048000000000000000000000000000000000000000000000000000000000000004c000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005c0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000013a000000000000000000000000000000000000000000000000000000000000014200000000000000000000000000000000000000000000000000000000000000020000000000000000000000000888888888889758f76e7103c6cbf23abbf58f9460000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000b205a2000000000000000000000000000000000000000000000000000000000000000200000000000000000000000004fe93ebc4ce6ae4f81601cc7ce7139023919e0030000000000000000000000000000000000000000000000000000000000000020000000000000000000000000dcad0f3992a72ea0ce5eb703293a353249c0a76f0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000af6f26e0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000896f4d49916ac5cfc36d7a260a7039ba4ea317b600000000000000000000000000000000000000000000000000000000000000200000000000000000000000009fb76f7ce5fceaa2c42887ff441d46095e494206000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e00000000000000000000000000000000000000000000000000000000000000200000000000000000000000006352a56caadc4f1e25cd6c75970fa768a3304e6400000000000000000000000000000000000000000000000000000000000000200000000000000000000000004d85ba8c3918359c78ed09581e5bc7578ba932ba000000000000000000000000000000000000000000000000000000000000002000000000000000000000000029219dd400f2bf60e5a23d13be72b486d40388940000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000b13fb5d0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000",
            address(dex),
            hex"0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000a67b61399b8b817e763f05def4694f22f1bdcc7d0000000000000000000000000000000000000000000000000000000000000d800000000000000000000000000000000000000000000000000000000000000d4490411a3200000000000000000000000012cfe671e9b186f21d9852d69bdbfe3f8ac9ecb1000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000004d85ba8c3918359c78ed09581e5bc7578ba932ba00000000000000000000000029219dd400f2bf60e5a23d13be72b486d403889400000000000000000000000012cfe671e9b186f21d9852d69bdbfe3f8ac9ecb1000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e000000000000000000000000000000000000000000000000000000000b1a698d0000000000000000000000000000000000000000000000000000000009f30fac0000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000d2163aad36affd04e4ae5cd82e37a73bb824ef0f0000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000007e0000000000000000000000000000000000000000000000000000000000000090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000104e5b07cdb0000000000000000000000008c51ddb04f4a6caa42992f43618c4d08bf44b6bf0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000b1a698d00000000000000000000000012cfe671e9b186f21d9852d69bdbfe3f8ac9ecb100000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000002e4d85ba8c3918359c78ed09581e5bc7578ba932ba000000d3dce716f3ef535c5ff8d041c1a41c3bd89b97ae00003400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000004e451a74316000000000000000000000000d3dce716f3ef535c5ff8d041c1a41c3bd89b97ae00000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000048000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064eb5625d9000000000000000000000000d3dce716f3ef535c5ff8d041c1a41c3bd89b97ae000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c8000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000ba12222222228d8ba445958a75a0704d566bf2c800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001c452bbbe2900000000000000000000000000000000000000000000000000000000000000e000000000000000000000000012cfe671e9b186f21d9852d69bdbfe3f8ac9ecb1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012cfe671e9b186f21d9852d69bdbfe3f8ac9ecb10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000ffffffff55f53f62977de2f3baabb94fd6e93759328561140002000000000000000001060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d3dce716f3ef535c5ff8d041c1a41c3bd89b97ae00000000000000000000000029219dd400f2bf60e5a23d13be72b486d4038894000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000044000000000000000000000000000000000000000000000000000000000000016400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000648a6a1e8500000000000000000000000029219dd400f2bf60e5a23d13be72b486d4038894000000000000000000000000922164bbbd36acf9e854acbbf32facc949fcaeef0000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000001a49f86542200000000000000000000000029219dd400f2bf60e5a23d13be72b486d403889400000000000000000000000000000001000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000004400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000064d1660f9900000000000000000000000029219dd400f2bf60e5a23d13be72b486d4038894000000000000000000000000bedfac7488dccaafdd66d1d7d56349780fe0477e00000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000034400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000009f8623a00000000000000000000000000000000000000000000000000000000"
        );
        dex.fillQuote(address(sellToken), allowanceTarget, swapCallData);

        assertEq(buyToken.balanceOf(address(dex)), 185858908, "expect to have USDC");
        assertEq(sellToken.allowance(address(dex), allowanceTarget), 0, "allowance should be reset to 0");
    }
}
